# Zeek Log Export Deployment

A set of resources, scripts, and tooling for deploying a k3d/k3s "zeek in a box" demo environment.

### Overview

Zeek is capable of producing network event logs from various sources including a pcap file or by monitoring network interfaces. These logs are typically written to files on the local filesystem based on the categorization of the network traffic. This project provides manifests and tooling for easily deploying a demo environment for Zeek logging capture and export inside a kubernetes cluster.

### The Service Stack

There are four primary services provided with this demo environment:
1. A Zeek pod which is comprised of an nginx, zeek, and fluent-bit container. This provides a simple endpoint which can be hit to generate logs. The logs generated by Zeek are exported via fluent-bit to the next service (Loki).
2. A Loki helm deployment which is already configured to store logs exported by the Zeek pod.
3. A Grafana helm deployment which is already configured to query and display logs stored in Loki.
4. A Traefik reverse proxy LB which comes with k3d. This is used to access the cluster services after deployment without port forwarding.

### Getting Started

The following should be installed and present in your PATH before creating your first demo environment:

1. `kubectl` for interacting the with cluster
2. `k3d` for managing the `k3s` cluster
3. `docker` for running the `k3d` cluster
4. `go` for running the E2E testing provided to ensure log export is working as expected

### Cluster Creation

Once the above is installed and configured, creating a cluster is as easy as running `make deploy` from the root of the repository.

This will create a custom Zeek container image, create the `k3d` cluster, import the image, deploy the various services, and finally output helpful information on the deployment. Output from running `make deploy` should looks something like this:

```
### BUILDING CUSTOM ZEEK IMAGE
[+] Building 0.8s (6/6) FINISHED                                                                                                                             docker:orbstack
 => [internal] load build definition from Dockerfile                                                                                                                    0.0s
 => => transferring dockerfile: 150B                                                                                                                                    0.0s
 => [internal] load metadata for docker.io/zeek/zeek:8.0.0                                                                                                              0.7s
 => [internal] load .dockerignore                                                                                                                                       0.0s
 => => transferring context: 2B                                                                                                                                         0.0s
 => [1/2] FROM docker.io/zeek/zeek:8.0.0@sha256:a4b547a27f3879f703d4979f0a8ff4571d0cbd061a32150eea0a760d3ea4b488                                                        0.0s
 => CACHED [2/2] RUN zkg --verbose install --force zeek/mitre-attack/bzar zeek/corelight/json-streaming-logs                                                            0.0s
 => exporting to image                                                                                                                                                  0.0s
 => => exporting layers                                                                                                                                                 0.0s
 => => writing image sha256:3113ebe760520e7cb5383e06c1731f94d04c522bb6b2c38c6d4402288f32ba8a                                                                            0.0s
 => => naming to docker.io/library/zeek-with-extras:0.0.1                                                                                                               0.0s

### CREATING K3D CLUSTER
INFO[0000] portmapping '443:443' targets the loadbalancer: defaulting to [servers:*:proxy agents:*:proxy]
INFO[0000] portmapping '80:80' targets the loadbalancer: defaulting to [servers:*:proxy agents:*:proxy]
INFO[0000] Prep: Network

<CUT>

Waiting for Grafana secret to exist...

### DEPLOYMENT COMPLETE!
################################################
###              CLUSTER DETAILS             ###
################################################

ZEEK WEB ENDPOINT: zeek.k3d.localhost

LOKI LOG ENDPOINT: loki.k3d.localhost

GRAFANA DASHBOARD: grafana.k3d.localhost
Username: admin
Password: <redacted>

### IMPORTANT! ###
DNS records should be added to /etc/hosts or similar to easily access cluster services
192.168.97.2    grafana.k3d.localhost
192.168.97.2    loki.k3d.localhost
192.168.97.2    zeek.k3d.localhost
```

Pay attention to the lines at the bottom of the deployment output. It's ideal to create the `*.k3d.localhost` records as listed so that you can run tests and access the services directly. This can be done by editing your local host resolution or creating custom records if you run your own DNS resolver.

If you are unable to, or don't want to do this step, you can access the services with commands such as the following for the three services:

```
kubectl port-forward -n zeek service/zeek 8080:80
kubectl port-forward -n grafana service/grafana 8081:80
kubectl port-forward -n loki service/loki 8082:80
```

Before moving on you can review the cluster pods to ensure everything is running with `kubectl get pods -A`. Your output should look similar to this:

```
NAMESPACE     NAME                                      READY   STATUS      RESTARTS   AGE
grafana       grafana-78cd7b46-tcc4f                    1/1     Running     0          81m
kube-system   coredns-ccb96694c-8jq2n                   1/1     Running     0          81m
kube-system   helm-install-grafana-d5md5                0/1     Completed   0          81m
kube-system   helm-install-traefik-crd-67rvp            0/1     Completed   0          81m
kube-system   helm-install-traefik-dfnpp                0/1     Completed   1          81m
kube-system   local-path-provisioner-5cf85fd84d-lz4nv   1/1     Running     0          81m
kube-system   metrics-server-5985cbc9d7-vkh8n           1/1     Running     0          81m
kube-system   svclb-traefik-6a248cb2-gfjh4              2/2     Running     0          81m
kube-system   traefik-5d45fc8cc9-v9hgl                  1/1     Running     0          81m
loki          grafana-loki-0                            2/2     Running     0          81m
loki          grafana-loki-chunks-cache-0               2/2     Running     0          81m
loki          grafana-loki-gateway-7f8b4bddcb-gqp6p     1/1     Running     0          81m
loki          grafana-loki-results-cache-0              2/2     Running     0          81m
loki          grafana-minio-0                           1/1     Running     0          81m
loki          loki-canary-g9m9l                         1/1     Running     0          81m
zeek          zeek-6f4c69cdcc-8x9nn                     3/3     Running     0          81m
```

### Testing

Tests which generate logs in the Zeek pod and then verify the logs are forwarded to the Loki service can be run with `make test`. Running the tests should provide output similar to the following:

```
=== RUN   TestZeekLogs
=== RUN   TestZeekLogs/index_generate_logs
=== RUN   TestZeekLogs/index_ensure_logs_in_loki
    zeek_test.go:79: waiting for logs in loki...
    zeek_test.go:79: waiting for logs in loki...
    zeek_test.go:79: waiting for logs in loki...
=== RUN   TestZeekLogs/foo_bar_generate_logs
=== RUN   TestZeekLogs/foo_bar_ensure_logs_in_loki
    zeek_test.go:79: waiting for logs in loki...
    zeek_test.go:79: waiting for logs in loki...
    zeek_test.go:79: waiting for logs in loki...
    zeek_test.go:79: waiting for logs in loki...
--- PASS: TestZeekLogs (9.27s)
    --- PASS: TestZeekLogs/index_generate_logs (0.04s)
    --- PASS: TestZeekLogs/index_ensure_logs_in_loki (4.11s)
    --- PASS: TestZeekLogs/foo_bar_generate_logs (0.01s)
    --- PASS: TestZeekLogs/foo_bar_ensure_logs_in_loki (5.11s)
PASS
ok      github.com/gabrieljackson/zeek-deployment       9.491s
```

You can also manually interact with the `nginx` server at `zeek.k3d.localhost` to generate logs.

### Browsing logs in Grafana

Grafana can be accessed via `grafana.k3d.localhost`. The credentials to log in are provided in the output from `make deploy` step.

### Cleaning Up

When you are ready to remove the k3d cluster you can run `make destroy` to fully clean up the demo environment.

### FAQ

Q: I see helm is used for deploying helm services, but it doesn't need to be installed on the host running `k3d`?
A: That's right, we used the [built-in Helm controller provided with k3s](https://docs.k3s.io/helm) to deploy the charts.

Q: There are a lot of network logs showing up in Loki/Grafana when I am not actively accessing the zeek nginx service. Why is that?
A: Zeek is monitoring the interface for all traffic so it will create logs from k8s probes, loki log export traffic, and a few other reccuring processes.

Q: I encountered an issue with the provided scripts. What is going on?
A: Development and testing for this project was done an arm-based macOS device, but any arm or x86 *nix based host should be able to run what is found here. Feel free to open an issue for assistance.

Q: I just created a demo cluster and don't see any logs yet. Why?
A: The cluster services may still be coming online. Depending on the resources available on the host this could take a bit of time to complete.
